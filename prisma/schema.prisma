generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  password      String?
  emailVerified DateTime?
  image         String?
  role          String    @default("CUSTOMER") // ADMIN, ESTABLISHMENT, CUSTOMER
  
  // Verificación multi-capa (expandida)
  verificationStatus String @default("PENDING") // PENDING, EMAIL_VERIFIED, IDENTITY_VERIFIED, TRUSTED_USER
  
  // Identidad leve
  profilePhoto      String?   // URL de foto de perfil
  realName          String?   // Nombre real verificado
  googleVerified    Boolean   @default(false) // Verificado con Google OAuth
  socialConnections String[]  @default([]) // ["google", "facebook", etc.]
  
  // Análisis de comportamiento
  trustScore        Float     @default(0.0) // 0.0 a 1.0
  lastActivity      DateTime?
  loginCount        Int       @default(0)
  suspiciousActivity Boolean  @default(false)
  
  // Reputación cruzada
  reputationScore   Float     @default(0.0) // 0.0 a 5.0 (como estrellas)
  totalRatings      Int       @default(0)
  positiveRatings   Int       @default(0)
  negativeRatings   Int       @default(0)
  
  // Verificación temporal
  lastVerification  DateTime? // Última verificación completa
  verificationExpiry DateTime? // Cuándo expira la verificación actual
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts          Account[]
  sessions          Session[]
  orders            Order[]
  establishment     Establishment?
  reviews           Review[]
  favorites         Favorite[]
  pushSubscriptions PushSubscription[]
  
  // Relaciones de reputación
  ratingsGiven      UserRating[] @relation("RaterUser")
  ratingsReceived   UserRating[] @relation("RatedUser")
  notifications     UserNotification[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model EmailVerification {
  id        String   @id @default(cuid())
  email     String
  code      String
  type      String   // "REGISTRATION", "LOGIN", "PASSWORD_RESET"
  expires   DateTime
  verified  Boolean  @default(false)
  attempts  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email, code])
  @@index([email, type])
}

model Establishment {
  id          String   @id @default(cuid())
  name        String
  description String?
  address     String
  latitude    Float
  longitude   Float
  phone       String?
  email       String?
  image       String?  // Logo principal
  category    String
  isActive    Boolean  @default(true)
  
  // Información adicional
  cuisineType        String?   // Tipo de cocina (italiana, mexicana, etc.)
  openingHours       String?   // JSON con horarios de atención
  paymentMethods     String[]  @default([]) // efectivo, tarjeta, transferencia
  images             String[]  @default([]) // Array de URLs de fotos
  website            String?   // Página web
  instagram          String?   // Usuario de Instagram
  facebook           String?   // URL de Facebook
  twitter            String?   // Usuario de Twitter
  
  // Documentación legal
  legalDocument      String?   // URL del documento legal
  businessType       String?   // Tipo de negocio (restaurante, bar, cafetería)
  taxId              String?   @unique // NIT o RUT (único)
  alcoholLicense     String?   // Licencia de bebidas alcohólicas (si aplica)
  
  // Verificación y estado
  verificationStatus String    @default("PENDING") // PENDING, AUTO_VERIFIED, APPROVED, REJECTED, SUSPENDED
  verificationType   String?   // AUTO, MANUAL, HYBRID
  verificationNotes  String?   // Notas del admin
  approvedAt         DateTime? // Fecha de aprobación
  approvedBy         String?   // ID del admin que aprobó
  suspendedAt        DateTime? // Fecha de suspensión
  suspendedReason    String?   // Razón de suspensión
  
  // Verificación automática
  googlePlaceId      String?   // ID de Google Places
  googleVerified     Boolean   @default(false) // Verificado con Google Places
  locationVerified   Boolean   @default(false) // Ubicación GPS verificada
  
  // Documentos de verificación
  frontPhoto         String?   // Foto del frente del local
  interiorPhoto      String?   // Foto del interior
  documentPhotos     String[]  @default([]) // Fotos de documentos (RUT, etc.)
  verificationDocs   String[]  @default([]) // URLs de documentos subidos
  
  // Gestión administrativa
  assignedAdminId    String?   // Admin asignado para gestionar
  lastModifiedBy     String?   // Último usuario que modificó
  registrationDate   DateTime  @default(now()) // Fecha de registro
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  packs     Pack[]
  posts     Post[]
  reviews   Review[]
  favorites Favorite[]
  menuItems MenuItem[]
  
  @@index([name])
  @@index([category])
  @@index([cuisineType])
  @@index([verificationStatus])
  @@index([taxId])
  @@index([isActive])
  @@index([assignedAdminId])
}

model Pack {
  id               String    @id @default(cuid())
  title            String
  description      String
  originalPrice    Float
  discountedPrice  Float
  quantity         Int
  availableFrom    DateTime
  availableUntil   DateTime
  pickupTimeStart  String // "18:00"
  pickupTimeEnd    String // "20:00"
  isActive         Boolean   @default(true)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  establishmentId String
  establishment   Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)

  orders Order[]
}

model Order {
  id               String      @id @default(cuid())
  quantity         Int
  totalAmount      Float
  status           String      @default("PENDING")
  pickupDate       DateTime
  stripePaymentId  String?
  
  // Campos de Mercado Pago
  paymentId        String?     // ID del pago de MercadoPago
  paymentStatus    String?     // Estado del pago (approved, rejected, pending, etc.)
  paymentMethod    String?     // Método de pago (visa, mastercard, mercadopago, etc.)
  paidAmount       Float?      // Monto pagado
  
  verificationCode String?     @unique // Código QR único para verificación
  verifiedAt       DateTime?   // Fecha de verificación por el restaurante
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  packId String
  pack   Pack   @relation(fields: [packId], references: [id], onDelete: Cascade)
  
  // Relación con ratings
  ratings UserRating[]
  
  @@index([verificationCode])
}

model Post {
  id          String   @id @default(cuid())
  title       String
  content     String
  images      String[]
  price       Float?
  isActive    Boolean  @default(true)
  likes       Int      @default(0)
  views       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  establishmentId String
  establishment   Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)

  @@index([establishmentId])
  @@index([createdAt])
}

model AuditLog {
  id          String   @id @default(cuid())
  action      String   // CREATE, UPDATE, DELETE, APPROVE, REJECT
  entityType  String   // USER, ESTABLISHMENT, POST, PACK, ORDER
  entityId    String
  userId      String   // Admin who performed the action
  userName    String?  // Cached user name
  changes     String?  // JSON string of changes
  metadata    String?  // Additional metadata
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
}

model Review {
  id              String        @id @default(cuid())
  rating          Int           // 1-5 estrellas
  comment         String?
  establishmentId String
  establishment   Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([userId, establishmentId]) // Un usuario solo puede dejar una reseña por restaurante
  @@index([establishmentId])
  @@index([userId])
  @@index([rating])
}

model Favorite {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  establishmentId String
  establishment   Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())

  @@unique([userId, establishmentId]) // Un usuario no puede agregar el mismo restaurante dos veces
  @@index([userId])
  @@index([establishmentId])
}

model MenuItem {
  id              String        @id @default(cuid())
  name            String
  description     String?
  price           Float
  category        String        // Entrada, Plato Principal, Postre, Bebida, etc.
  image           String?
  isAvailable     Boolean       @default(true)
  preparationTime Int?          // Minutos
  allergens       String[]      @default([]) // Gluten, Lácteos, Nueces, etc.
  isVegetarian    Boolean       @default(false)
  isVegan         Boolean       @default(false)
  isGlutenFree    Boolean       @default(false)
  establishmentId String
  establishment   Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([establishmentId])
  @@index([category])
  @@index([isAvailable])
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
  @@index([userId])
}

model UserRating {
  id        String   @id @default(cuid())
  rating    Float    // 1.0 a 5.0
  comment   String?
  context   String   // "ORDER", "INTERACTION", "GENERAL"
  
  // Relaciones
  raterId   String   // Quien califica
  ratedId   String   // Quien es calificado
  orderId   String?  // Orden relacionada (opcional)
  
  rater     User     @relation("RaterUser", fields: [raterId], references: [id], onDelete: Cascade)
  rated     User     @relation("RatedUser", fields: [ratedId], references: [id], onDelete: Cascade)
  order     Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([raterId, ratedId, orderId]) // Un usuario solo puede calificar una vez por orden
  @@index([ratedId])
  @@index([raterId])
}

model UserNotification {
  id          String   @id @default(cuid())
  userId      String
  type        String   // "VERIFICATION_CHANGE", "REPUTATION_UPDATE", "TRUST_SCORE_CHANGE"
  title       String
  message     String
  data        String?  // JSON con datos adicionales
  read        Boolean  @default(false)
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([read])
}

model SystemMetric {
  id          String   @id @default(cuid())
  metricType  String   // "TRUST_SCORE_AVG", "SUSPICIOUS_USERS", "VERIFICATION_RATE"
  value       Float
  metadata    String?  // JSON con detalles adicionales
  
  createdAt   DateTime @default(now())
  
  @@index([metricType])
  @@index([createdAt])
}

// Removed enums for SQLite compatibility
// UserRole: CUSTOMER, ESTABLISHMENT, ADMIN
// EstablishmentCategory: RESTAURANT, CAFE, BAKERY, SUPERMARKET, GROCERY, OTHER  
// OrderStatus: PENDING, CONFIRMED, READY_FOR_PICKUP, COMPLETED, CANCELLED
// VerificationStatus: PENDING, EMAIL_VERIFIED, IDENTITY_VERIFIED, TRUSTED_USER
